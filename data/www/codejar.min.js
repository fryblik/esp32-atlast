/* https://github.com/antonmedv/codejar */
const globalWindow=window;export function CodeJar(t,e,n={}){const o=Object.assign({tab:"\t",indentOn:/{$/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:globalWindow},n),r=o.window,s=r.document;let i,a,d=[],c=[],l=-1,f=!1,u=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;t.setAttribute("contentEditable",u?"true":"plaintext-only"),t.setAttribute("spellcheck",o.spellcheck?"true":"false"),t.style.outline="none",t.style.overflowWrap="break-word",t.style.overflowY="auto",t.style.resize="vertical",t.style.whiteSpace="pre-wrap",e(t);const p=A(()=>{const n=k();e(t,n),C(n)},30);let g=!1;const h=t=>!E(t)&&!x(t)&&"Meta"!==t.key&&"Control"!==t.key&&"Alt"!==t.key&&!t.key.startsWith("Arrow"),y=A(t=>{h(t)&&(m(),g=!1)},300),b=(e,n)=>{d.push([e,n]),t.addEventListener(e,n)};function k(){const e=H(),n={start:0,end:0,dir:void 0};return w(t,t=>{if(t===e.anchorNode&&t===e.focusNode)return n.start+=e.anchorOffset,n.end+=e.focusOffset,n.dir=e.anchorOffset<=e.focusOffset?"->":"<-","stop";if(t===e.anchorNode){if(n.start+=e.anchorOffset,n.dir)return"stop";n.dir="->"}else if(t===e.focusNode){if(n.end+=e.focusOffset,n.dir)return"stop";n.dir="<-"}t.nodeType===Node.TEXT_NODE&&("->"!=n.dir&&(n.start+=t.nodeValue.length),"<-"!=n.dir&&(n.end+=t.nodeValue.length))}),n}function C(e){const n=H();let o,r,s=0,i=0;if(e.dir||(e.dir="->"),e.start<0&&(e.start=0),e.end<0&&(e.end=0),"<-"==e.dir){const{start:t,end:n}=e;e.start=n,e.end=t}let a=0;w(t,t=>{if(t.nodeType!==Node.TEXT_NODE)return;const n=(t.nodeValue||"").length;if(a+n>=e.start&&(o||(o=t,s=e.start-a),a+n>=e.end))return r=t,i=e.end-a,"stop";a+=n}),o||(o=t),r||(r=t),"<-"==e.dir&&([o,s,r,i]=[r,i,o,s]),n.setBaseAndExtent(o,s,r,i)}function O(){const e=H().getRangeAt(0),n=s.createRange();return n.selectNodeContents(t),n.setEnd(e.startContainer,e.startOffset),n.toString()}function v(){const e=H().getRangeAt(0),n=s.createRange();return n.selectNodeContents(t),n.setStart(e.endContainer,e.endOffset),n.toString()}function T(t){if(u&&"Enter"===t.key)if(L(t),t.stopPropagation(),""==v()){S("\n ");const t=k();t.start=--t.end,C(t)}else S("\n")}function m(){if(!f)return;const e=t.innerHTML,n=k(),o=c[l];if(o&&o.html===e&&o.pos.start===n.start&&o.pos.end===n.end)return;c[++l]={html:e,pos:n},c.splice(l+1);l>300&&(l=300,c.splice(0,1))}function w(t,e){const n=[];t.firstChild&&n.push(t.firstChild);let o=n.pop();for(;o&&"stop"!==e(o);)o.nextSibling&&n.push(o.nextSibling),o.firstChild&&n.push(o.firstChild),o=n.pop()}function N(t){return t.metaKey||t.ctrlKey}function E(t){return N(t)&&!t.shiftKey&&"z"===t.key}function x(t){return N(t)&&t.shiftKey&&"z"===t.key}function S(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),s.execCommand("insertHTML",!1,t)}function A(t,e){let n=0;return(...o)=>{clearTimeout(n),n=r.setTimeout(()=>t(...o),e)}}function M(t){let e=t.length-1;for(;e>=0&&"\n"!==t[e];)e--;let n=++e;for(;n<t.length&&/[ \t]/.test(t[n]);)n++;return[t.substring(e,n)||"",e,n]}function D(){return t.textContent||""}function L(t){t.preventDefault()}function H(){var e;return(null===(e=t.parentNode)||void 0===e?void 0:e.nodeType)==Node.DOCUMENT_FRAGMENT_NODE?t.parentNode.getSelection():r.getSelection()}return b("keydown",e=>{e.defaultPrevented||(a=D(),o.preserveIdent?function(t){if("Enter"===t.key){const e=O(),n=v();let[r]=M(e),s=r;if(o.indentOn.test(e)&&(s+=o.tab),s.length>0?(L(t),t.stopPropagation(),S("\n"+s)):T(t),s!==r&&"}"===n[0]){const t=k();S("\n"+r),C(t)}}}(e):T(e),o.catchTab&&function(t){if("Tab"===t.key)if(L(t),t.shiftKey){const t=O();let[e,n]=M(t);if(e.length>0){const t=k(),r=Math.min(o.tab.length,e.length);C({start:n,end:n+r}),s.execCommand("delete"),t.start-=r,t.end-=r,C(t)}}else S(o.tab)}(e),o.addClosing&&function(t){const e="([{'\"",n=")]}'\"",o=v(),r=O(),s="\\"===r.substr(r.length-1),i=o.substr(0,1);if(n.includes(t.key)&&!s&&i===t.key){const e=k();L(t),e.start=++e.end,C(e)}else if(e.includes(t.key)&&!s&&("\"'".includes(t.key)||[""," ","\n"].includes(i))){L(t);const o=k(),r=o.start==o.end?"":H().toString(),s=t.key+r+n[e.indexOf(t.key)];S(s),o.start++,o.end++,C(o)}}(e),o.history&&(!function(e){if(E(e)){L(e);const n=c[--l];n&&(t.innerHTML=n.html,C(n.pos)),l<0&&(l=0)}if(x(e)){L(e);const n=c[++l];n&&(t.innerHTML=n.html,C(n.pos)),l>=c.length&&l--}}(e),h(e)&&!g&&(m(),g=!0)))}),b("keyup",t=>{t.defaultPrevented||t.isComposing||(a!==D()&&p(),y(t),i&&i(D()))}),b("focus",t=>{f=!0}),b("blur",t=>{f=!1}),b("paste",n=>{m(),function(n){L(n);const o=(n.originalEvent||n).clipboardData.getData("text/plain").replace(/\r/g,""),r=k();S(o),e(t),C({start:r.start+o.length,end:r.start+o.length})}(n),m(),i&&i(D())}),{updateOptions(t){t=Object.assign(Object.assign({},t),t)},updateCode(n){t.textContent=n,e(t)},onUpdate(t){i=t},toString:D,save:k,restore:C,recordHistory:m,destroy(){for(let[e,n]of d)t.removeEventListener(e,n)}}}